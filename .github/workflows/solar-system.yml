name: Solar System Workflow

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - "feature/*"

# متغيرات عامة (تتعمل Vars/Secrets من Settings)
env:
  MONGO_USERNAME: ${{ vars.MONGO_USERNAME }}
  MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
  # لو عندك Mongo URI كـ Secret (مفضل)
  MONGO_URI: ${{ secrets.MONGO_URI }}

jobs:
  # 1) Unit Testing (Runs on VM + Mongo Service Container) => لازم Port Mapping + localhost
  unit-testing:
    name: Unit Testing
    runs-on: ubuntu-latest

    services:
      mongo-db:
        image: siddharth67/mongo-db:non-prod
        ports:
          - 27017:27017

    strategy:
      fail-fast: false
      matrix:
        nodejs_version: [18, 20]

    # Override للـ DB علشان تبقى local service container
    env:
      MONGO_URI: "mongodb://localhost:27017/superData"
      MONGO_USERNAME: "non-prod-user"
      MONGO_PASSWORD: "non-prod-password"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.nodejs_version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.nodejs_version }}
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Run Unit Tests
        run: npm test


  # 2) Code Coverage (Runs INSIDE Job Container + Mongo Service Container) => بدون Port Mapping
  code-coverage:
    name: Code Coverage
    needs: unit-testing
    runs-on: ubuntu-latest

    container:
      image: node:18

    services:
      mongo-db:
        image: siddharth67/mongo-db:non-prod
        options: --name mongo

    env:
      MONGO_URI: "mongodb://mongo:27017/superData"
      MONGO_USERNAME: "non-prod-user"
      MONGO_PASSWORD: "non-prod-password"

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: npm ci

      - name: Run Coverage
        run: npm run coverage


  # 3) Docker Build/Test/Push (DockerHub ONLY)
  docker:
    name: Containerization (Build/Test/Push)
    needs: [unit-testing, code-coverage]
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      # DockerHub Login (لازم يكون DOCKERHUB_USERNAME variable + DOCKERHUB_PASSWORD secret)
      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # Build image locally for testing (بدون Push)
      - name: Docker Build for Testing
        uses: docker/build-push-action@v4
        with:
          context: .
          push: false
          tags: ${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }}

      # Run container test (health endpoint)
      - name: Docker Image Testing
        run: |
          docker images

          docker run --name solar-system-app -d \
            -p 3000:3000 \
            -e MONGO_URI="${{ secrets.MONGO_URI }}" \
            -e MONGO_USERNAME="${{ vars.MONGO_USERNAME }}" \
            -e MONGO_PASSWORD="${{ secrets.MONGO_PASSWORD }}" \
            ${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }}

          echo "Waiting app to start..."
          sleep 5

          echo "Testing /live endpoint"
          wget -qO- "http://127.0.0.1:3000/live" | grep live

          docker logs --tail=50 solar-system-app || true
          docker rm -f solar-system-app || true

      # Push to DockerHub (نفس ال SHA tag)
      - name: Push to DockerHub
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: |
            ${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }}


  # 4) Dev Deploy (Install kubectl + kubeconfig + apply manifests + integration test)
  dev-deploy:
    name: Deploy to Dev Cluster
    needs: docker
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.26.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > ~/.kube/config

      - name: Verify Cluster Access
        run: |
          kubectl version --short
          echo "------------------------------"
          kubectl get nodes

      - name: Deploy to Dev Namespace
        run: |
          kubectl get ns dev || kubectl create ns dev

          # استخدم DockerHub image بدل GHCR
          kubectl -n dev set image deployment/solar-system \
            app=${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }} \
            --record || true

          kubectl apply -n dev -f k8s/dev/

          kubectl -n dev rollout status deployment/solar-system --timeout=180s
          kubectl -n dev get pods

      - name: Integration Test (Dev)
        run: |
          echo "Testing Dev URL: ${{ vars.DEV_URL }}"
          wget -qO- "${{ vars.DEV_URL }}/live" | grep live


  # 5) Prod Deploy (Manual Approval via GitHub Environment)
  prod-deploy:
    name: Deploy to Prod Cluster
    needs: dev-deploy
    runs-on: ubuntu-latest

    environment: production

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.26.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 --decode > ~/.kube/config

      - name: Deploy to Prod Namespace
        run: |
          kubectl get ns prod || kubectl create ns prod

          # استخدم DockerHub image بدل GHCR
          kubectl -n prod set image deployment/solar-system \
            app=${{ vars.DOCKERHUB_USERNAME }}/solar-system:${{ github.sha }} \
            --record || true

          kubectl apply -n prod -f k8s/prod/

          kubectl -n prod rollout status deployment/solar-system --timeout=180s
          kubectl -n prod get pods

      - name: Integration Test (Prod)
        run: |
          echo "Testing Prod URL: ${{ vars.PROD_URL }}"
          wget -qO- "${{ vars.PROD_URL }}/live" | grep live
